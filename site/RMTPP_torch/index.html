
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../managers/">
      
      
        <link rel="next" href="../CLI/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>RMTPP torch - ProcessProphet docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#rmtpp_torch" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ProcessProphet docs" class="md-header__button md-logo" aria-label="ProcessProphet docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ProcessProphet docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              RMTPP torch
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ProcessProphet docs" class="md-nav__button md-logo" aria-label="ProcessProphet docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    ProcessProphet docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Docs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Docs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../server_routes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API documentation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../managers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Backend
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    RMTPP torch
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    RMTPP torch
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model" class="md-nav__link">
    <span class="md-ellipsis">
      model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model.Net" class="md-nav__link">
    <span class="md-ellipsis">
      Net
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Net">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model.Net.RMTPPLoss" class="md-nav__link">
    <span class="md-ellipsis">
      RMTPPLoss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model.Net.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model.Net.predict_sorted" class="md-nav__link">
    <span class="md-ellipsis">
      predict_sorted
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util" class="md-nav__link">
    <span class="md-ellipsis">
      util
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.ATMDataset" class="md-nav__link">
    <span class="md-ellipsis">
      ATMDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ATMDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.ATMDataset.generate_sequence" class="md-nav__link">
    <span class="md-ellipsis">
      generate_sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.ATMDataset.importance_weight" class="md-nav__link">
    <span class="md-ellipsis">
      importance_weight
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.ATMDataset.to_features" class="md-nav__link">
    <span class="md-ellipsis">
      to_features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.clf_metric" class="md-nav__link">
    <span class="md-ellipsis">
      clf_metric
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CLI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CLI
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model" class="md-nav__link">
    <span class="md-ellipsis">
      model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model.Net" class="md-nav__link">
    <span class="md-ellipsis">
      Net
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Net">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model.Net.RMTPPLoss" class="md-nav__link">
    <span class="md-ellipsis">
      RMTPPLoss
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model.Net.predict" class="md-nav__link">
    <span class="md-ellipsis">
      predict
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.model.Net.predict_sorted" class="md-nav__link">
    <span class="md-ellipsis">
      predict_sorted
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util" class="md-nav__link">
    <span class="md-ellipsis">
      util
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.ATMDataset" class="md-nav__link">
    <span class="md-ellipsis">
      ATMDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ATMDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.ATMDataset.generate_sequence" class="md-nav__link">
    <span class="md-ellipsis">
      generate_sequence
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.ATMDataset.importance_weight" class="md-nav__link">
    <span class="md-ellipsis">
      importance_weight
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.ATMDataset.to_features" class="md-nav__link">
    <span class="md-ellipsis">
      to_features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.RMTPP_torch.util.clf_metric" class="md-nav__link">
    <span class="md-ellipsis">
      clf_metric
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="rmtpp_torch">RMTPP_torch</h1>


<div class="doc doc-object doc-module">



<a id="server.RMTPP_torch.model"></a>
    <div class="doc doc-contents first">

      <p>this neural network model is based on the paper
"Recurrent Marked Temporal Point Processes: Embedding Event History to Vector" by 
Du, et al. 
In particular, the implementation is a modified version from the repository
<code>https://github.com/woshiyyya/ERPP-RMTPP.git</code>.</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="server.RMTPP_torch.model.Net" class="doc doc-heading">
            <code>Net</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>


              <details class="quote">
                <summary>Source code in <code>server/RMTPP_torch/model.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">lossweight</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">n_class</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">number_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">number_classes</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">emb_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emb_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
        <span class="c1">#droputs transform some random entries into zeros. Its used for regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">emb_dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>         <span class="c1">#we add one to the input because we merge the embedding vector with the time input (float)</span>
                            <span class="n">hidden_size</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hid_dim</span><span class="p">,</span>
                            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span>   <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">hid_dim</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlp_dim</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">mlp_drop</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlp_dim</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">number_classes</span><span class="p">)</span> <span class="c1">#here we generate the output logits for the label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_linear</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">in_features</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">mlp_dim</span><span class="p">,</span> <span class="n">out_features</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#here we calc the time prediction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_criterion</span><span class="p">(</span><span class="n">lossweight</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">lossweight</span> <span class="o">=</span> <span class="n">lossweight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span> <span class="c1">#the author uses BertAdam, but we will just use Adam </span>

    <span class="k">def</span> <span class="nf">set_optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">total_step</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">set_criterion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
        <span class="c1">#: cross entropy for the markers/label logits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cuda</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">intensity_w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intensity_b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_criterion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RMTPPLoss</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">intensity_w</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intensity_b</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_criterion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RMTPPLoss</span>


    <span class="k">def</span> <span class="nf">RMTPPLoss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">gold</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate the loss for the time. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_w</span> <span class="o">*</span> <span class="n">gold</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_b</span> <span class="o">+</span>
                          <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_b</span><span class="p">)</span> <span class="o">-</span>
                           <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_w</span> <span class="o">*</span> <span class="n">gold</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_b</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_w</span><span class="p">)</span> <span class="c1">#: loss function for the time prediction (see paper)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">loss</span>



    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_time</span><span class="p">,</span> <span class="n">input_events</span><span class="p">):</span>
        <span class="n">event_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">input_events</span><span class="p">)</span>
        <span class="n">event_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emb_drop</span><span class="p">(</span><span class="n">event_embedding</span><span class="p">)</span>

        <span class="c1"># merge the embed vector with the time input (extra row)</span>
        <span class="n">lstm_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">event_embedding</span><span class="p">,</span> <span class="n">input_time</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hidden_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">lstm_input</span><span class="p">)</span> 

        <span class="c1"># hidden_state = torch.cat((hidden_state, input_time.unsqueeze(-1)), dim=-1) THIS WAS COMMENTED FROM BEFORE</span>
        <span class="n">mlp_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">hidden_state</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span>  <span class="c1">#multi layer perceptorn output</span>
        <span class="n">mlp_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_drop</span><span class="p">(</span><span class="n">mlp_output</span><span class="p">)</span> 
        <span class="c1">#Here we are basically passing the output through TWO DIFFERENT LAYERS separately.</span>
        <span class="n">event_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_linear</span><span class="p">(</span><span class="n">mlp_output</span><span class="p">)</span>  <span class="c1"># the output is separated and passed to a specific activation function</span>
        <span class="n">time_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_linear</span><span class="p">(</span><span class="n">mlp_output</span><span class="p">)</span>  <span class="c1"># the output is separated and passed to a specific activation function</span>
        <span class="k">return</span> <span class="n">time_logits</span><span class="p">,</span> <span class="n">event_logits</span>  <span class="c1"># get the predictions </span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cuda</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tensors</span><span class="p">)):</span>

                <span class="n">tensors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tensors</span><span class="p">)):</span>
                <span class="n">tensors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tensors</span>


    <span class="k">def</span> <span class="nf">train_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="n">time_tensor</span><span class="p">,</span> <span class="n">event_tensor</span> <span class="o">=</span> <span class="n">batch</span>

        <span class="c1">#here we make sure to REMOVE THE LABEL from the training input. that is why we do &quot;slicing&quot;</span>
        <span class="n">time_input</span><span class="p">,</span> <span class="n">time_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">time_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">event_input</span><span class="p">,</span> <span class="n">event_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">event_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">event_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">time_logits</span><span class="p">,</span> <span class="n">event_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">time_input</span><span class="p">,</span> <span class="n">event_input</span><span class="p">)</span>
        <span class="c1">#calc loss</span>
        <span class="n">loss1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_criterion</span><span class="p">(</span><span class="n">time_logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">time_target</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">loss2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_criterion</span><span class="p">(</span><span class="n">event_logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_class</span><span class="p">),</span> <span class="n">event_target</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">loss1</span> <span class="o">+</span> <span class="n">loss2</span>  <span class="c1">#total loss formula </span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1">#backpropagation trhough time.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span> <span class="c1">#reset grads</span>
        <span class="k">return</span> <span class="n">loss1</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">loss2</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">pm_active</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a prediction.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch (tuple): A batch containing one or more inputs for doing predictions.</span>
<span class="sd">            pm_active (bool): If True, returns only the most likely prediction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple or int: If pm_active is True, returns a tuple containing the index (encoded marker) of the event that has the highest probability, the maximum probability, and the last time prediction. </span>
<span class="sd">                  If pm_active is False, returns two lists. The first list contains the timestamps of the predictions, and the second list contains the index (encoded marker) of the event that has the highest probability.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_tensor</span><span class="p">,</span> <span class="n">event_tensor</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="c1">#make sure to cut out the last event/timestamp from each sequence: </span>
        <span class="n">time_input</span><span class="p">,</span> <span class="n">time_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">time_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">event_input</span><span class="p">,</span> <span class="n">event_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">event_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">event_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">time_logits</span><span class="p">,</span> <span class="n">event_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">time_input</span><span class="p">,</span> <span class="n">event_input</span><span class="p">)</span>
        <span class="n">event_pred</span><span class="o">=</span>  <span class="n">event_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">event_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">event_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#for each label find the index that maximizes the pred.</span>
        <span class="k">if</span> <span class="n">pm_active</span><span class="p">:</span> 
            <span class="c1">#: in case we just need the most likely prediction</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="n">event_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1">#get event logits from last run</span>
            <span class="n">max_prob</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
            <span class="n">event_index</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">max_prob</span><span class="p">)</span> <span class="c1">#compute argmax </span>
            <span class="n">time_pred</span> <span class="o">=</span> <span class="n">time_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1">#: get last time prdiction</span>
            <span class="k">return</span> <span class="n">event_index</span><span class="p">,</span> <span class="n">max_prob</span><span class="p">,</span><span class="n">time_pred</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


        <span class="n">time_pred</span> <span class="o">=</span> <span class="n">time_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">time_pred</span><span class="p">,</span> <span class="n">event_pred</span>


    <span class="k">def</span> <span class="nf">predict_sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a prediction.</span>

<span class="sd">        Args:</span>
<span class="sd">            batch (tuple): A batch containing one or more inputs for doing predictions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing two lists. The first list contains the timestamps of the predictions, and the second list contains tuples of the form `(probability, event_index)`. This second list is sorted in descending order, with the event with the highest probability at the beginning. The `event_index` corresponds to the encoding of a marker.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_tensor</span><span class="p">,</span> <span class="n">event_tensor</span> <span class="o">=</span> <span class="n">batch</span>
        <span class="c1">#make sure to cut out the last event/timestamp from each sequence: </span>
        <span class="n">time_input</span><span class="p">,</span> <span class="n">time_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">time_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">event_input</span><span class="p">,</span> <span class="n">event_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">event_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">event_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">time_logits</span><span class="p">,</span> <span class="n">event_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">time_input</span><span class="p">,</span> <span class="n">event_input</span><span class="p">)</span>

        <span class="n">event_pred</span> <span class="o">=</span> <span class="n">event_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">event_pred_with_indices</span><span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span>  <span class="n">logit_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">event_pred</span><span class="p">):</span> 
            <span class="n">index_list</span><span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">event_index</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">softmax</span><span class="p">(</span><span class="n">logit_list</span><span class="p">)):</span>
                <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prediction</span><span class="p">,</span> <span class="n">event_index</span><span class="p">))</span>
            <span class="n">index_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">event_pred_with_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span>
        <span class="n">time_pred</span> <span class="o">=</span> <span class="n">time_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">time_pred</span><span class="p">,</span> <span class="n">event_pred_with_indices</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="server.RMTPP_torch.model.Net.RMTPPLoss" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">RMTPPLoss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">gold</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>calculate the loss for the time.</p>

            <details class="quote">
              <summary>Source code in <code>server/RMTPP_torch/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">RMTPPLoss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">gold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate the loss for the time. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_w</span> <span class="o">*</span> <span class="n">gold</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_b</span> <span class="o">+</span>
                      <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_b</span><span class="p">)</span> <span class="o">-</span>
                       <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pred</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_w</span> <span class="o">*</span> <span class="n">gold</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_b</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_w</span><span class="p">)</span> <span class="c1">#: loss function for the time prediction (see paper)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">loss</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="server.RMTPP_torch.model.Net.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pm_active</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Make a prediction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>batch</code></td>
            <td>
                  <code>tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A batch containing one or more inputs for doing predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pm_active</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, returns only the most likely prediction.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple or int: If pm_active is True, returns a tuple containing the index (encoded marker) of the event that has the highest probability, the maximum probability, and the last time prediction. 
  If pm_active is False, returns two lists. The first list contains the timestamps of the predictions, and the second list contains the index (encoded marker) of the event that has the highest probability.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>server/RMTPP_torch/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">pm_active</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a prediction.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (tuple): A batch containing one or more inputs for doing predictions.</span>
<span class="sd">        pm_active (bool): If True, returns only the most likely prediction.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple or int: If pm_active is True, returns a tuple containing the index (encoded marker) of the event that has the highest probability, the maximum probability, and the last time prediction. </span>
<span class="sd">              If pm_active is False, returns two lists. The first list contains the timestamps of the predictions, and the second list contains the index (encoded marker) of the event that has the highest probability.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_tensor</span><span class="p">,</span> <span class="n">event_tensor</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="c1">#make sure to cut out the last event/timestamp from each sequence: </span>
    <span class="n">time_input</span><span class="p">,</span> <span class="n">time_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">time_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">event_input</span><span class="p">,</span> <span class="n">event_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">event_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">event_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">time_logits</span><span class="p">,</span> <span class="n">event_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">time_input</span><span class="p">,</span> <span class="n">event_input</span><span class="p">)</span>
    <span class="n">event_pred</span><span class="o">=</span>  <span class="n">event_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">event_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">event_pred</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#for each label find the index that maximizes the pred.</span>
    <span class="k">if</span> <span class="n">pm_active</span><span class="p">:</span> 
        <span class="c1">#: in case we just need the most likely prediction</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">event_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1">#get event logits from last run</span>
        <span class="n">max_prob</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
        <span class="n">event_index</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">max_prob</span><span class="p">)</span> <span class="c1">#compute argmax </span>
        <span class="n">time_pred</span> <span class="o">=</span> <span class="n">time_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1">#: get last time prdiction</span>
        <span class="k">return</span> <span class="n">event_index</span><span class="p">,</span> <span class="n">max_prob</span><span class="p">,</span><span class="n">time_pred</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


    <span class="n">time_pred</span> <span class="o">=</span> <span class="n">time_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">time_pred</span><span class="p">,</span> <span class="n">event_pred</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="server.RMTPP_torch.model.Net.predict_sorted" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict_sorted</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Make a prediction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>batch</code></td>
            <td>
                  <code>tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A batch containing one or more inputs for doing predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tuple</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple containing two lists. The first list contains the timestamps of the predictions, and the second list contains tuples of the form <code>(probability, event_index)</code>. This second list is sorted in descending order, with the event with the highest probability at the beginning. The <code>event_index</code> corresponds to the encoding of a marker.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>server/RMTPP_torch/model.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a prediction.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch (tuple): A batch containing one or more inputs for doing predictions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing two lists. The first list contains the timestamps of the predictions, and the second list contains tuples of the form `(probability, event_index)`. This second list is sorted in descending order, with the event with the highest probability at the beginning. The `event_index` corresponds to the encoding of a marker.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_tensor</span><span class="p">,</span> <span class="n">event_tensor</span> <span class="o">=</span> <span class="n">batch</span>
    <span class="c1">#make sure to cut out the last event/timestamp from each sequence: </span>
    <span class="n">time_input</span><span class="p">,</span> <span class="n">time_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">time_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">event_input</span><span class="p">,</span> <span class="n">event_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">([</span><span class="n">event_tensor</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">event_tensor</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">time_logits</span><span class="p">,</span> <span class="n">event_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">time_input</span><span class="p">,</span> <span class="n">event_input</span><span class="p">)</span>

    <span class="n">event_pred</span> <span class="o">=</span> <span class="n">event_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">event_pred_with_indices</span><span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span>  <span class="n">logit_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">event_pred</span><span class="p">):</span> 
        <span class="n">index_list</span><span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event_index</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">softmax</span><span class="p">(</span><span class="n">logit_list</span><span class="p">)):</span>
            <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">prediction</span><span class="p">,</span> <span class="n">event_index</span><span class="p">))</span>
        <span class="n">index_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">event_pred_with_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_list</span><span class="p">)</span>
    <span class="n">time_pred</span> <span class="o">=</span> <span class="n">time_logits</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">time_pred</span><span class="p">,</span> <span class="n">event_pred_with_indices</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="server.RMTPP_torch.util"></a>
    <div class="doc doc-contents first">

      <p>this module computes the input for the RNN. It is assumed that the input
event log is in the right format, i.e. rows are sorted by case id and timestamp, 
and the columns are encoded properly. </p>
<p>It computes time differences and uses a sliding window.</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="server.RMTPP_torch.util.ATMDataset" class="doc doc-heading">
            <code>ATMDataset</code>


</h2>


    <div class="doc doc-contents ">


      <p>helper class for the neural network that
is in charge of doing the sliding window algorithm
over the sequences and get the time differences
in the timestamp column of the data. </p>
<p>it can be seen as a wrapper that does some further 
preprocessing that is very especific to the NN.</p>

              <details class="quote">
                <summary>Source code in <code>server/RMTPP_torch/util.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ATMDataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    helper class for the neural network that</span>
<span class="sd">    is in charge of doing the sliding window algorithm</span>
<span class="sd">    over the sequences and get the time differences</span>
<span class="sd">    in the timestamp column of the data. </span>

<span class="sd">    it can be seen as a wrapper that does some further </span>
<span class="sd">    preprocessing that is very especific to the NN.        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">case_id</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span><span class="n">event_key</span><span class="p">,</span><span class="n">in_recursive_call</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">case_id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">timestamp_key</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">event_key</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">seq_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_recursive_call</span> <span class="o">=</span> <span class="n">in_recursive_call</span> <span class="c1">#variable used for multiple predictions</span>
        <span class="k">if</span>  <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_recursive_call</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_seqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_seqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_sequence</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">time_seqs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_seqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sliding_window</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_time_stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>



    <span class="k">def</span> <span class="nf">sliding_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">event_windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">time_windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">event_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span><span class="p">])</span>
        <span class="n">time_window</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span><span class="p">])</span>
        <span class="n">event_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">event_window</span><span class="p">))</span>
        <span class="n">time_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">time_window</span><span class="p">))</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">end_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)):</span>
            <span class="n">event_window</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">event_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">[</span><span class="n">end_idx</span><span class="p">])</span>
            <span class="n">time_window</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">time_window</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">end_idx</span><span class="p">])</span>
            <span class="n">time_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">time_window</span><span class="p">))</span>
            <span class="n">event_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">event_window</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">time_windows</span><span class="p">,</span> <span class="n">event_windows</span>

    <span class="k">def</span> <span class="nf">generate_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        use the sliding window algorithm so that the sequences</span>
<span class="sd">        fit in the NN (this way we fit the proper tensor dimension) .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">MAX_INTERVAL_VARIANCE</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#tqdm is the progress bar</span>
        <span class="n">time_seqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">event_seqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cur_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1">#: this is a sliding window algorithm to cut each input sequence into sub sequences of the same length</span>
        <span class="k">while</span> <span class="n">cur_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cur_start</span> <span class="o">=</span> <span class="n">cur_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">cur_start</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">cur_end</span><span class="p">]:</span>
                <span class="n">cur_end</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="n">subseq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">cur_start</span><span class="p">:</span><span class="n">cur_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1">#print(subseq)</span>
            <span class="c1"># if max(subseq) - min(subseq) &gt; MAX_INTERVAL_VARIANCE:</span>
            <span class="c1">#     if self.subset == &quot;train&quot;:</span>
            <span class="c1">#         cur_end += 1</span>
            <span class="c1">#         continue</span>
            <span class="n">time_seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subseq</span><span class="p">)</span>
            <span class="n">event_seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">[</span><span class="n">cur_start</span><span class="p">:</span><span class="n">cur_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">cur_end</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">time_seqs</span><span class="p">,</span> <span class="n">event_seqs</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_seqs</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_seqs</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_seqs</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">to_features</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            Two tensors: one containing the time differences between adjacent time stamps</span>
<span class="sd">            and the other one containing the events.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">times</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">time</span><span class="p">)</span>

            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="c1">#return torch.FloatTensor(times), torch.LongTensor(events)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">times</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">events</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">statistic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TOTAL SEQs:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_seqs</span><span class="p">))</span>
        <span class="c1"># intervals = np.diff(np.array(self.time))</span>
        <span class="c1"># for thr in [0.001, 0.01, 0.1, 1, 10, 100]:</span>
        <span class="c1">#     print(f&quot;&lt;{thr} = {np.mean(intervals &lt; thr)}&quot;)</span>

    <span class="k">def</span> <span class="nf">importance_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        used for CrossEntropyLoss </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="k">return</span> <span class="n">weight</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="server.RMTPP_torch.util.ATMDataset.generate_sequence" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_sequence</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>use the sliding window algorithm so that the sequences
fit in the NN (this way we fit the proper tensor dimension) .</p>

            <details class="quote">
              <summary>Source code in <code>server/RMTPP_torch/util.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    use the sliding window algorithm so that the sequences</span>
<span class="sd">    fit in the NN (this way we fit the proper tensor dimension) .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MAX_INTERVAL_VARIANCE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#tqdm is the progress bar</span>
    <span class="n">time_seqs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">event_seqs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cur_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="c1">#: this is a sliding window algorithm to cut each input sequence into sub sequences of the same length</span>
    <span class="k">while</span> <span class="n">cur_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cur_start</span> <span class="o">=</span> <span class="n">cur_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq_len</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">cur_start</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="n">cur_end</span><span class="p">]:</span>
            <span class="n">cur_end</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">subseq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">cur_start</span><span class="p">:</span><span class="n">cur_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1">#print(subseq)</span>
        <span class="c1"># if max(subseq) - min(subseq) &gt; MAX_INTERVAL_VARIANCE:</span>
        <span class="c1">#     if self.subset == &quot;train&quot;:</span>
        <span class="c1">#         cur_end += 1</span>
        <span class="c1">#         continue</span>
        <span class="n">time_seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subseq</span><span class="p">)</span>
        <span class="n">event_seqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">[</span><span class="n">cur_start</span><span class="p">:</span><span class="n">cur_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">cur_end</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">time_seqs</span><span class="p">,</span> <span class="n">event_seqs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="server.RMTPP_torch.util.ATMDataset.importance_weight" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">importance_weight</span><span class="p">(</span><span class="n">count</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>used for CrossEntropyLoss</p>

            <details class="quote">
              <summary>Source code in <code>server/RMTPP_torch/util.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">importance_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    used for CrossEntropyLoss </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
    <span class="k">return</span> <span class="n">weight</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="server.RMTPP_torch.util.ATMDataset.to_features" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_features</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">



    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Two tensors: one containing the time differences between adjacent time stamps</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>and the other one containing the events.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>server/RMTPP_torch/util.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">to_features</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">        Two tensors: one containing the time differences between adjacent time stamps</span>
<span class="sd">        and the other one containing the events.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">times</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">time</span><span class="p">)</span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="c1">#return torch.FloatTensor(times), torch.LongTensor(events)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">times</span><span class="p">)),</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">events</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="server.RMTPP_torch.util.clf_metric" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clf_metric</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">gold</span><span class="p">,</span> <span class="n">n_class</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>compute test metrics.
:return:
- recall 
- precision
- f1 score</p>

            <details class="quote">
              <summary>Source code in <code>server/RMTPP_torch/util.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">clf_metric</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">gold</span><span class="p">,</span> <span class="n">n_class</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    compute test metrics.</span>
<span class="sd">    :return:</span>
<span class="sd">    - recall </span>
<span class="sd">    - precision</span>
<span class="sd">    - f1 score</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gold_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">gold</span><span class="p">)</span>
    <span class="n">pred_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">prec</span> <span class="o">=</span> <span class="n">recall</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pcnt</span> <span class="o">=</span> <span class="n">rcnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_class</span><span class="p">):</span>
        <span class="c1">#print(np.logical_and(pred == gold, pred == i))</span>
        <span class="n">match_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">gold</span><span class="p">,</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gold_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prec</span> <span class="o">+=</span> <span class="n">match_count</span> <span class="o">/</span> <span class="n">gold_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pcnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">pred_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">recall</span> <span class="o">+=</span> <span class="n">match_count</span> <span class="o">/</span> <span class="n">pred_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">rcnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">prec</span> <span class="o">/=</span> <span class="n">pcnt</span>
    <span class="n">recall</span> <span class="o">/=</span> <span class="n">rcnt</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pcnt=</span><span class="si">{</span><span class="n">pcnt</span><span class="si">}</span><span class="s2">, rcnt=</span><span class="si">{</span><span class="n">rcnt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="o">*</span><span class="mi">15</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">prec</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">recall</span><span class="p">))</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">prec</span> <span class="o">*</span> <span class="n">recall</span> <span class="o">/</span> <span class="p">(</span><span class="n">prec</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prec</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">f1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
    
  </body>
</html>